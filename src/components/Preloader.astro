<!-- Preloader -->
<div id="loading" class="fixed inset-0 z-[99999] flex items-center justify-center transition-opacity duration-500" style="background-color: var(--main1);">
    <div class="flex flex-col items-center gap-6">
        <!-- Logo -->
        <div class="relative w-[120px] h-[120px] flex items-center justify-center">
            <span class="text-[52px] font-black preloader-gradient-text select-none leading-none">
                RR
            </span>

            <!-- Soft Pulse Ring -->
            <span class="preloader-ring"></span>
        </div>

        <!-- Progress -->
        <div class="w-[280px]">
            <div class="h-1 rounded-full overflow-hidden" style="background-color: rgba(237, 42, 42, 0.1);">
                <div id="progress-bar" class="h-full w-0 preloader-progress-bg transition-[width] duration-300">
                </div>
            </div>

            <p id="progress-percentage" class="mt-2 text-sm text-center tracking-widest tabular-nums" style="color: var(--secondary); opacity: 0.7;">
                0%
            </p>
        </div>

        <!-- Tagline -->
        <p class="text-xs uppercase tracking-[3px]" style="color: var(--secondary); opacity: 0.5;">
            Automating the Future
        </p>
    </div>
</div>

<style>
    #loading {
        will-change: opacity;
    }

    @keyframes gradientShift {
        0% {
            background-position: 0% 50%;
        }

        100% {
            background-position: 100% 50%;
        }
    }

    .preloader-gradient-text {
        background: var(--navbar);
        background-size: 200% 200%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: gradientShift 6s linear infinite;
    }

    @keyframes softPulse {

        0%,
        100% {
            transform: scale(1);
            opacity: 0.6;
        }

        50% {
            transform: scale(1.05);
            opacity: 1;
        }
    }

    .preloader-ring {
        position: absolute;
        inset: -6px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        animation: softPulse 2.5s ease-in-out infinite;
        pointer-events: none;
        box-shadow: 0 0 20px var(--primary);
    }

    .preloader-progress-bg {
        position: relative;
        background: var(--navbar);
        background-size: 200% 200%;
        overflow: hidden;
    }

    .preloader-progress-bg,
    .preloader-gradient-text {
        animation: gradientShift 6s linear infinite;
    }

    @keyframes shimmer {
        0% {
            transform: translateX(-100%);
        }

        100% {
            transform: translateX(100%);
        }
    }

    .preloader-progress-bg::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg,
                transparent,
                rgba(255, 255, 255, 0.35),
                transparent);
        transform: translateX(-100%);
        animation: shimmer 2.5s infinite;
    }

    .tabular-nums {
        font-variant-numeric: tabular-nums;
    }
</style>

<script>
    const loader = document.getElementById('loading');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-percentage');

    let progress = 0;
    const hasHash = window.location.hash;

    // Asset tracking
    let totalAssets = 0;
    let loadedAssets = 0;
    let assetsTracked = false;

    function updateProgress(newProgress: number) {
        progress = Math.min(100, Math.max(0, newProgress));
        if (progressBar) progressBar.style.width = progress + '%';
        if (progressText) progressText.textContent = Math.round(progress) + '%';

        if (progress >= 100) {
            completeLoading();
        }
    }

    function completeLoading() {
        if (loader) {
            loader.style.opacity = '0';

            setTimeout(() => {
                if (loader) {
                    loader.style.display = 'none';
                    document.body.classList.add('loaded');

                    if (hasHash) {
                        const target = document.querySelector(hasHash);
                        if (target instanceof HTMLElement) {
                            const offset = 80;
                            window.scrollTo({
                                top: target.offsetTop - offset,
                                behavior: 'smooth'
                            });
                        }
                    }
                }
            }, 400);
        }
    }

    function onAssetLoaded() {
        loadedAssets++;
        const assetProgress = (loadedAssets / totalAssets) * 80; // 80% for assets
        const baseProgress = hasHash ? 30 : 10;
        updateProgress(baseProgress + assetProgress);
    }

    function trackAssetLoading() {
        if (assetsTracked) return;
        assetsTracked = true;

        // Get all images
        const images = Array.from(document.querySelectorAll('img'));

        // Get all background images from computed styles
        const elementsWithBgImages = [];
        document.querySelectorAll('*').forEach(el => {
            const computedStyle = window.getComputedStyle(el);
            const bgImage = computedStyle.backgroundImage;
            if (bgImage && bgImage !== 'none' && bgImage.includes('url(')) {
                elementsWithBgImages.push(el);
            }
        });

        // Get all fonts (check if any custom fonts are loading)
        const fontPromises = [];
        if (document.fonts) {
            document.fonts.forEach(font => {
                if (font.status === 'loading') {
                    fontPromises.push(font.loaded.then(() => {}));
                }
            });
        }

        // Calculate total assets
        totalAssets = images.length + elementsWithBgImages.length + fontPromises.length;

        // If no assets to track, complete immediately
        if (totalAssets === 0) {
            updateProgress(100);
            return;
        }

        // Start with hash-based progress if applicable
        updateProgress(hasHash ? 30 : 10);

        // Track image loading
        images.forEach(img => {
            if (img.complete && img.naturalHeight !== 0) {
                onAssetLoaded();
            } else {
                const handleLoad = () => {
                    onAssetLoaded();
                    img.removeEventListener('load', handleLoad);
                    img.removeEventListener('error', handleLoad);
                };
                img.addEventListener('load', handleLoad);
                img.addEventListener('error', handleLoad);
            }
        });

        // Track background images
        elementsWithBgImages.forEach(el => {
            const computedStyle = window.getComputedStyle(el);
            const bgImage = computedStyle.backgroundImage;
            const urlMatch = bgImage.match(/url\(['"]?([^'"]+)['"]?\)/);

            if (urlMatch) {
                const img = new Image();
                img.onload = img.onerror = onAssetLoaded;
                img.src = urlMatch[1];
            } else {
                onAssetLoaded();
            }
        });

        // Track font loading
        fontPromises.forEach(fontPromise => {
            fontPromise.then(onAssetLoaded, onAssetLoaded);
        });

        // Fallback timeout to prevent infinite loading
        setTimeout(() => {
            if (progress < 100) {
                updateProgress(100);
            }
        }, 8000);
    }

    // Single initialization point
    function initPreloader() {
        setTimeout(trackAssetLoading, 100);
    }

    // Initialize based on document state
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPreloader);
    } else {
        initPreloader();
    }

    // Backup completion trigger
    window.addEventListener('load', () => {
        setTimeout(() => {
            if (progress < 90) {
                updateProgress(100);
            }
        }, 500);
    });
</script>