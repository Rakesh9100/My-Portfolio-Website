---
import experiencesData from '../../public/assets/jsons/experiences.json';
const experiences = experiencesData;
// Tech stack icons mapping for visualization
const techIcons = {
    "HTML": "üåê",
    "CSS": "üé®",
    "JavaScript": "‚ö°",
    "React": "‚öõÔ∏è",
    "Node.js": "üü¢",
    "Python": "üêç",
    "Java": "‚òï",
    "C++": "‚öôÔ∏è",
    "SQL": "üóÑÔ∏è",
    "Git": "üìù",
    "GitHub": "üêô",
    "GitLab": "ü¶ä",
    "Docker": "üê≥",
    "Kubernetes": "‚ò∏Ô∏è",
    "Helm": "‚õµ",
    "Linux": "üêß",
    "GCP": "‚òÅÔ∏è",
    "AWS": "üü†",
    "XML": "üìÑ",
    "Groovy": "üîß",
    "Machine Learning": "ü§ñ"
};
---

<section class="experience section-common section-bg-secondary" id="experience">
    <div class="title relative text-center font-bold mb-4 md:mb-6">
        <span class="section-title text-[8vw] sm:text-[6vw] md:text-[5vw] lg:text-[3.5vw] uppercase">My Experience</span>
    </div>

    <div class="text text-center mb-8 md:mb-12 lg:mb-16 px-4">
        <span class="quote-text">Experience is not what happens to you; it's what you do with what happens to you.</span>
    </div>

    <!-- Experience Filter -->
    <div class="experience-filter flex justify-center gap-4 flex-wrap my-10 mx-auto px-5 relative z-10">
        <button class="exp-filter-btn active" data-filter="all">
            <span class="filter-icon">üåü</span>
            <span class="filter-text-full">All</span>
            <span class="filter-text-short hidden">All</span>
        </button>
        <button class="exp-filter-btn" data-filter="work">
            <span class="filter-icon">üíº</span>
            <span class="filter-text-full">Work</span>
            <span class="filter-text-short hidden">Work</span>
        </button>
        <button class="exp-filter-btn" data-filter="opensource">
            <span class="filter-icon">üöÄ</span>
            <span class="filter-text-full">Open Source</span>
            <span class="filter-text-short hidden">Open</span>
        </button>
        <button class="exp-filter-btn" data-filter="internship">
            <span class="filter-icon">üéì</span>
            <span class="filter-text-full">Internship</span>
            <span class="filter-text-short hidden">Intern</span>
        </button>
    </div>

    <!-- Experience Timeline -->
    <div class="experience-timeline-container relative max-w-[1000px] mx-auto px-5">
        <div class="experience-timeline-line absolute top-0 bottom-0 w-1" style="background: linear-gradient(180deg, transparent 0%, var(--primary) 15%, var(--primary) 85%, transparent 100%);"></div>

        <div class="experience-boxes flex flex-col gap-8 relative" id="experience-boxes">
            {experiences.slice(0, 6).map((exp) => (
            <div class="exp-box relative exp-card-ready" data-category={exp.category}>
                <div class="timeline-dot">
                    <div class="dot-inner"></div>
                </div>

                <div class="exp-content">
                    <div class="exp-header">
                        <div class="company-duration-row">
                            <div class="company-badge">
                                {exp.logo && (
                                <div class="company-logo-container">
                                    <img src={exp.logo} alt={`${exp.company} logo`} class="company-logo" loading="lazy" width="36" height="36" decoding="async" />
                                </div>
                                )}
                                <span class="company-name">{exp.company}</span>
                            </div>
                            <div class="duration-badge">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                                <span class="duration-text">{exp.duration}</span>
                            </div>
                        </div>
                        <h3 class="role-title">{exp.role}</h3>
                    </div>

                    <ul class="exp-description list-none p-0 m-0 flex flex-col gap-2.5">
                        {exp.description.filter(desc => !desc.includes('Tech Stacks')).map((desc) => (
                        <li class="flex items-start gap-3 text-sm leading-relaxed" style="color: rgba(255, 255, 255, 0.9);">
                            <span class="text-base flex-shrink-0 mt-0.5" style="color: var(--primary);">‚ñπ</span>
                            <span set:html={desc}></span>
                        </li>
                        ))}
                    </ul>

                    <!-- Tech Stack Visualization -->
                    {(() => {
                    const techStackDesc = exp.description.find(desc => desc.includes('Tech Stacks'));
                    return techStackDesc && (
                    <div class="tech-stack-section mt-4 pt-4 border-t border-white/10">
                        <h4 class="text-sm font-semibold text-white/80 mb-3 flex items-center gap-2">
                            <span class="tech-icon">üõ†Ô∏è</span>
                            Tech Stack
                        </h4>
                        <div class="tech-stack-grid flex flex-wrap gap-2">
                            {techStackDesc.split(':-')[1]?.split(',').map((tech) => {
                            const cleanTech = tech.trim();
                            return (
                            <div class="tech-item flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium transition-all duration-300">
                                <span class="tech-emoji text-sm">{techIcons[cleanTech as keyof typeof techIcons] || '‚ö°'}</span>
                                <span>{cleanTech}</span>
                            </div>
                            );
                            })}
                        </div>
                    </div>
                    );
                    })()}
                </div>
            </div>
            ))}

            {experiences.slice(6).map((exp) => (
            <div class="exp-box hidden-exp relative exp-card-ready" data-category={exp.category} style="display: none;">
                <div class="timeline-dot">
                    <div class="dot-inner"></div>
                </div>

                <div class="exp-content">
                    <div class="exp-header">
                        <div class="company-duration-row">
                            <div class="company-badge">
                                {exp.logo && (
                                <div class="company-logo-container">
                                    <img src={exp.logo} alt={`${exp.company} logo`} class="company-logo" loading="lazy" width="36" height="36" decoding="async" />
                                </div>
                                )}
                                <span class="company-name">{exp.company}</span>
                            </div>
                            <div class="duration-badge">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                                <span class="duration-text">{exp.duration}</span>
                            </div>
                        </div>
                        <h3 class="role-title">{exp.role}</h3>
                    </div>

                    <ul class="exp-description list-none p-0 m-0 flex flex-col gap-2.5">
                        {exp.description.filter(desc => !desc.includes('Tech Stacks')).map((desc) => (
                        <li class="flex items-start gap-3 text-sm leading-relaxed" style="color: rgba(255, 255, 255, 0.9);">
                            <span class="text-base flex-shrink-0 mt-0.5" style="color: var(--primary);">‚ñπ</span>
                            <span set:html={desc}></span>
                        </li>
                        ))}
                    </ul>

                    <!-- Tech Stack Visualization -->
                    {(() => {
                    const techStackDesc = exp.description.find(desc => desc.includes('Tech Stacks'));
                    return techStackDesc && (
                    <div class="tech-stack-section mt-4 pt-4 border-t border-white/10">
                        <h4 class="text-sm font-semibold text-white/80 mb-3 flex items-center gap-2">
                            <span class="tech-icon">üõ†Ô∏è</span>
                            Tech Stack
                        </h4>
                        <div class="tech-stack-grid flex flex-wrap gap-2">
                            {techStackDesc.split(':-')[1]?.split(',').map((tech) => {
                            const cleanTech = tech.trim();
                            return (
                            <div class="tech-item flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium transition-all duration-300">
                                <span class="tech-emoji text-sm">{techIcons[cleanTech as keyof typeof techIcons] || '‚ö°'}</span>
                                <span>{cleanTech}</span>
                            </div>
                            );
                            })}
                        </div>
                    </div>
                    );
                    })()}
                </div>
            </div>
            ))}
        </div>
    </div>

    <!-- Load More Button -->
    <div class="load-more-container flex justify-center mt-12" id="load-more-container">
        <button class="load-more-btn" id="load-more-btn">
            <span class="load-more-text-full">Load More Experiences</span>
            <span class="load-more-text-short hidden">Load More</span>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="transition-transform duration-300">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        </button>
    </div>
</section>

<style>
    .exp-filter-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        transition: transform 0.3s ease;
        border: 2px solid var(--ternary);
        background: rgba(26, 15, 62, 0.3);
    }

    .exp-filter-btn:hover,
    .exp-filter-btn.active {
        transform: translateY(2px);
        background: var(--navbar);
    }

    .exp-box:hover .exp-content {
        transform: translateX(6px);
        border-color: var(--primary);
    }

    @keyframes expCardFadeIn {
        0% {
            opacity: 0;
            transform: translateY(20px);
        }

        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .exp-card-animated {
        animation: expCardFadeIn 0.6s ease-out forwards;
    }

    .exp-box {
        padding-left: 60px;
    }

    .exp-content {
        border-radius: 20px;
        padding: 1.5rem;
        background: rgba(26, 15, 62, 0.3);
        border: 3px solid rgba(255, 255, 255, 0.15);
        transition: transform 0.35s ease, border-color 0.35s ease;
    }

    .exp-header {
        display: flex;
        flex-direction: column;
        margin-bottom: 1rem;
        gap: 0.75rem;
    }

    .company-duration-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .company-badge {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 0.8rem;
        padding: 0.3rem 0.6rem;
        border-radius: 50px;
        width: fit-content;
        background: var(--gradient2);
        border: 1px solid rgba(255, 255, 255, 0.15);
        overflow: hidden;
        flex-shrink: 1;
        min-width: 0;
    }

    .company-badge::before {
        content: "";
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.25); /* üîΩ dim layer */
        pointer-events: none;
    }

    .company-badge > * {
        position: relative;
        z-index: 1;
    }

    .company-logo-container {
        width: 2.25rem;
        height: 2.25rem;
        border-radius: 50%;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .company-logo {
        width: 100%;
        height: 100%;
        display: block;
        object-fit: contain;
        filter: brightness(1.5);
        backface-visibility: hidden;
        user-select: none;
        -webkit-user-drag: none;
    }

    .company-name {
        font-size: 0.9rem;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        word-break: break-word;
        line-height: 1.3;
    }

    .role-title {
        font-size: 1.25rem;
        font-weight: bold;
        margin: 0;
        background: var(--gradient1);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .duration-badge {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        background: var(--hover);
        border: 1px solid var(--primary);
        opacity: 0.9;
        flex-shrink: 0;
    }

    .duration-text {
        font-size: 0.9rem;
        font-weight: 700;
        color: white;
    }

    .experience-timeline-line {
        left: 35px;
    }

    .timeline-dot {
        left: 23px;
        top: 1rem;
        position: absolute;
        width: 1.25rem;
        height: 1.25rem;
        border-radius: 50%;
        z-index: 10;
        background: var(--gradient1);
    }

    .dot-inner {
        width: 0.625rem;
        height: 0.625rem;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--secondary);
    }

    .tech-item {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.75rem;
        font-weight: 700;
        transition: transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        background: var(--hover);
        border: 1px solid var(--primary);
        opacity: 0.9;
    }

    .tech-item:hover {
        transform: translateY(-2px) scale(1.05);
        background-color: var(--primary);
        border-color: var(--hover);
        opacity: 1;
    }

    .tech-emoji {
        transition: transform 0.3s ease;
    }

    .tech-item:hover .tech-emoji {
        transform: scale(1.2) rotate(10deg);
    }

    .load-more-btn {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.8rem 1.5rem;
        border-radius: 50px;
        color: var(--secondary);
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.4s ease;
        border: 2px solid var(--ternary);
        background: var(--primary);
    }

    .load-more-btn:hover {
        border-color: var(--hover);
        transform: scale(1.02);
        opacity: 1;
    }

    @media (max-width: 640px) {
        .experience {
            padding: 4rem 1rem 3rem;
        }

        .filter-text-full,
        .load-more-text-full {
            display: none;
        }

        .filter-text-short,
        .load-more-text-short {
            display: inline;
        }

        .exp-filter-btn {
            padding: 0.5rem 1rem;
            font-size: 14px;
        }

        .experience-timeline-line {
            left: 10px;
        }

        .exp-box {
            padding-left: 27px;
        }

        .timeline-dot {
            left: 0px;
        }

        .exp-content {
            padding: 1rem;
        }

        .company-badge,
        .company-duration-row {
            gap: 0.5rem;
        }

        .company-logo-container {
            width: 1.5rem;
            height: 1.5rem;
        }

        .role-title {
            font-size: 1.1rem;
        }

        .duration-badge {
            padding: 0.5rem 0.75rem;
            align-self: flex-start;
        }

        .exp-description li {
            font-size: 0.8rem;
            gap: 0.5rem;
        }

        .load-more-btn {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            gap: 0.5rem;
        }
    }
</style>

<script>
    // Filter functionality
    const filterBtns = document.querySelectorAll<HTMLButtonElement>('.exp-filter-btn');
    const expBoxes = document.querySelectorAll<HTMLElement>('.exp-box');
    const loadMoreContainer = document.getElementById('load-more-container');
    let currentFilter = 'all';
    let visibleCount = 6;

    filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const filter = btn.getAttribute('data-filter') || 'all';
            currentFilter = filter;
            visibleCount = 6; // Reset visible count when changing filter

            // Update active button
            filterBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Get matching experiences for current filter
            const matchingBoxes = Array.from(expBoxes).filter(box => {
                const category = box.getAttribute('data-category') || '';
                return filter === 'all' || category === filter;
            });

            // Hide all boxes first
            expBoxes.forEach(box => {
                box.style.display = 'none';
                box.style.opacity = '0';
                box.style.transform = 'translateY(0)';
                box.classList.add('hidden-exp');
            });

            // Show first 6 matching experiences
            matchingBoxes.slice(0, 6).forEach(box => {
                box.style.display = 'block';
                box.style.opacity = '1';
                box.style.transform = 'translateY(0)';
                box.classList.remove('hidden-exp');
            });

            // Handle load more button visibility
            if (matchingBoxes.length > 6) {
                if (loadMoreContainer) {
                    loadMoreContainer.style.display = 'flex';
                    loadMoreContainer.style.opacity = '1';
                }
            } else {
                if (loadMoreContainer) {
                    loadMoreContainer.style.display = 'none';
                }
            }
        });
    });

    // Load More functionality
    const loadMoreBtn = document.getElementById('load-more-btn');
    const hiddenExps = document.querySelectorAll<HTMLElement>('.hidden-exp');

    if (hiddenExps.length === 0) {
        const container = document.getElementById('load-more-container');
        if (container) container.style.display = 'none';
    }

    loadMoreBtn?.addEventListener('click', () => {
        // Get matching experiences for current filter
        const matchingBoxes = Array.from(expBoxes).filter(box => {
            const category = box.getAttribute('data-category') || '';
            return currentFilter === 'all' || category === currentFilter;
        });

        // Show next 6 experiences
        const nextBatch = matchingBoxes.slice(visibleCount, visibleCount + 6);
        nextBatch.forEach((exp, index) => {
            setTimeout(() => {
                exp.style.display = 'block';
                exp.classList.remove('hidden-exp');
                exp.style.opacity = '1';
                exp.style.transform = 'translateY(0)';
            }, index * 100);
        });

        visibleCount += 6;

        // Hide load more button if all matching experiences are shown
        if (visibleCount >= matchingBoxes.length) {
            const container = document.getElementById('load-more-container');
            if (container) {
                container.style.opacity = '0';
                setTimeout(() => {
                    container.style.display = 'none';
                }, 300);
            }
        }
    });

    // Intersection Observer for animations
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const expCards = entry.target.querySelectorAll('.exp-card-ready');
                expCards.forEach((card, index) => {
                    setTimeout(() => {
                        card.classList.add('exp-card-animated');
                        card.classList.remove('exp-card-ready');
                    }, index * 100);
                });
                observer.unobserve(entry.target);
            }
        });
    }, observerOptions);

    const expSection = document.querySelector('.experience');
    if (expSection) observer.observe(expSection);

    // Style for focus class in descriptions
    const focusElements = document.querySelectorAll<HTMLElement>('.focus');
    focusElements.forEach(el => {
        el.style.background = 'var(--gradient2)';
        el.style.backgroundClip = 'text';
        (el.style as any).webkitBackgroundClip = 'text';
        (el.style as any).webkitTextFillColor = 'transparent';
        el.style.fontWeight = '700';
    });
</script>