---
import { Image } from "astro:assets";
import logo from "../assets/images/logo.png";

const navItems = [
    { href: '#home', label: 'HOME' },
    { href: '#about', label: 'ABOUT' },
    { href: '#skills', label: 'SKILLS' },
    { href: '#experience', label: 'EXPERIENCE' },
    { href: '#projects', label: 'PROJECTS' },
    { href: '#certificates', label: 'CERTIFICATIONS' },
    { href: '#contact', label: 'CONTACT' },
];
---

<nav class="navbar fixed w-full z-[999] transition-all duration-300 px-4 sm:px-6 md:px-8 py-2">
    <div class="max-width max-w-full mx-auto flex items-center justify-between px-3 sm:px-4 py-1.5 rounded-[20px] sm:rounded-[25px] relative bg-[rgba(11,15,26,0.9)] border border-white/10">
        <!-- Logo -->
        <a href="#home" aria-label="Go to home" class="logo-link">
            <Image src={logo} alt="Rakesh Roshan logo" width={200} height={60} class="img-logo" />
        </a>

        <!-- Desktop Menu -->
        <ul class="menu hidden lg:flex list-none items-center gap-0.5">
            {navItems.map((item, index) => {
                const isActive = index === 0 ? ' active' : '';
                return (
                    <li class="inline-flex items-center">
                        <a href={item.href} class={`nav-link relative inline-flex items-center justify-center text-white/90 font-bold px-2 lg:px-3 xl:px-4 py-2.5 rounded-[15px] overflow-hidden transition-all duration-400 hover:text-white hover:-translate-y-1${isActive}`} style="font-size: clamp(10px, 1.2vw, 16px); line-height: 1;">
                        {item.label}
                        </a>
                    </li>
                );
            })}
        </ul>

        <!-- Right Section -->
        <div class="navbar-right flex items-center gap-3 sm:gap-4 md:gap-5">
            <!-- Resume Button -->
            <a href="/assets/Rakesh_Roshan_Resume.pdf" target="_blank" rel="noopener noreferrer" aria-label="Open resume in new tab" class="resume-btn relative flex items-center gap-2 px-3 sm:px-4 md:px-5 py-2 sm:py-2.5 rounded-full text-white font-semibold text-xs sm:text-sm transition-colors duration-300 bg-[rgba(11,15,26,0.9)]">

                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="relative z-[1] transition-transform duration-300 sm:w-[18px] sm:h-[18px]">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                <span class="relative z-[1]">Resume</span>
            </a>

            <!-- Theme Switcher -->
            <div class="theme-switcher relative z-[1000]" id="theme-switcher">
                <button class="theme-toggle-btn w-9 h-9 sm:w-10 sm:h-10 rounded-full flex items-center justify-center transition-all duration-300 text-white" id="theme-toggle-btn" aria-label="Toggle Theme Switcher">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="20" height="20" fill="currentColor">
                        <path d="M512 256c0 .9 0 1.8 0 2.7c-.4 36.5-33.6 61.3-70.1 61.3H344c-26.5 0-48 21.5-48 48c0 3.4 .4 6.7 1 9.9c2.1 10.2 6.5 20 10.8 29.9c6.1 13.8 12.1 27.5 12.1 42c0 31.8-21.6 60.7-53.4 62c-3.5 .1-7 .2-10.6 .2C114.6 512 0 397.4 0 256S114.6 0 256 0S512 114.6 512 256zM128 288a32 32 0 1 0 -64 0 32 32 0 1 0 64 0zm0-96a32 32 0 1 0 0-64 32 32 0 1 0 0 64zM288 96a32 32 0 1 0 -64 0 32 32 0 1 0 64 0zm96 96a32 32 0 1 0 0-64 32 32 0 1 0 0 64z"/>
                    </svg>
                </button>
                <div class="theme-options absolute top-[55px] right-0 rounded-[15px] px-4 py-4 opacity-0 invisible -translate-y-2.5 transition-all duration-300 min-w-[180px]" id="theme-options" style="background: rgba(11, 15, 26, 0.95); border: 2px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);">
                    <button class="theme-btn active w-full flex items-center gap-3 px-4 py-2.5 mb-2 rounded-[10px] transition-all duration-300 text-white text-sm font-semibold" data-theme="sunset">
                        <span class="theme-color w-[30px] h-[30px] rounded-full block theme-sunset"></span>
                        <span class="theme-name flex-1 text-left">Sunset</span>
                    </button>

                    <button class="theme-btn w-full flex items-center gap-3 px-4 py-2.5 mb-2 rounded-[10px] transition-all duration-300 text-white text-sm font-semibold" data-theme="midnight">
                        <span class="theme-color w-[30px] h-[30px] rounded-full block theme-midnight"></span>
                        <span class="theme-name flex-1 text-left">Midnight</span>
                    </button>

                    <button class="theme-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-[10px] transition-all duration-300 text-white text-sm font-semibold" data-theme="forest">
                        <span class="theme-color w-[30px] h-[30px] rounded-full block theme-forest"></span>
                        <span class="theme-name flex-1 text-left">Forest</span>
                    </button>
                </div>
            </div>

            <!-- Mobile menu button -->
            <button class="menu-btn lg:hidden text-white text-2xl" id="menu-toggle" aria-label="Toggle Menu">
                <svg class="hamburger w-6 h-6" fill="currentColor" viewBox="0 0 448 512">
                    <path d="M0 96C0 78.3 14.3 64 32 64l384 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L32 128C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32l384 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L32 288c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32L32 448c-17.7 0-32-14.3-32-32s14.3-32 32-32l384 0c17.7 0 32 14.3 32 32z"/>
                </svg>
                <svg class="close hidden w-6 h-6" fill="currentColor" viewBox="0 0 384 512">
                    <path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Mobile Menu -->
    <div class="mobile-menu lg:hidden fixed top-[70px] left-0 right-0 opacity-0 invisible translate-y-[-20px] transition-all duration-300 z-[999] px-4" id="mobile-menu">
        <div class="mobile-menu-content rounded-[20px] overflow-hidden" style="background: rgba(11, 15, 26, 0.98);">
            <ul class="list-none p-4">
                {navItems.map((item, index) => {
                    const isActive = index === 0 ? ' active' : '';
                    return (
                        <li class="mb-2">
                            <a href={item.href} class={`mobile-nav-link block text-center text-white font-bold px-4 py-3 rounded-[12px] transition-all duration-300 hover:text-white${isActive}`} style="font-size: 14px;">
                            {item.label}
                            </a>
                        </li>
                    );
                })}
            </ul>
        </div>
    </div>
</nav>

<style>
    .logo-link,
    .menu a,
    .navbar-right a {
        user-select: none;
        -webkit-user-drag: none;
    }

    .logo-link {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 45px;
        padding: 0 6px;
        overflow: hidden;
        transition: transform 0.4s ease;
    }

    .logo-link:hover {
        transform: translateY(-1px);
    }

    .img-logo {
        height: 100%;
        max-height: 50px;
        width: auto;
        object-fit: contain;
        pointer-events: none;
    }

    .nav-link {
        text-align: center;
        box-sizing: border-box;
        transition: color 0.3s ease, background 0.3s ease, transform 0.3s ease;
    }

    .nav-link,
    .nav-link:focus,
    .nav-link:focus-visible,
    .nav-link:active {
        outline: none !important;
        border: none !important;
    }

    .nav-link::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(59, 130, 246, 0.15));
        opacity: 0;
        transition: opacity 0.5s ease;
        border-radius: 15px;
    }

    .nav-link:hover::before {
        opacity: 1;
    }

    .nav-link:hover {
        transform: translateY(-2px);
    }

    .navbar .menu li a.active {
        background: var(--navbar);
        color: var(--secondary);
        border-radius: 15px;
    }

    .resume-btn {
        border: 2px solid transparent;
        background: linear-gradient(rgba(11,15,26,0.9), rgba(11,15,26,0.9)) padding-box, var(--navbar) border-box;
    }

    .resume-btn:hover {
        background: linear-gradient(rgba(11,15,26,0.9), rgba(11,15,26,0.9)) padding-box, var(--gradient1) border-box;
    }

    @keyframes bounceDown {
        0%,
        100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(5px);
        }
    }

    .resume-btn:hover svg {
        animation: bounceDown 0.6s ease infinite;
    }

    .theme-toggle-btn {
        transition: transform 0.3s ease;
        background: color-mix(in srgb, var(--primary) 20%, transparent);
        border: 2px solid color-mix(in srgb, var(--primary) 60%, transparent);
    }

    .theme-btn {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .theme-sunset {
        background: var(--navbar);
    }

    .theme-midnight {
        background: linear-gradient(135deg, #3498db 0%, #4CA1AF 100%);
    }

    .theme-forest {
        background: linear-gradient(135deg, #3a9d5d 0%, #71B280 100%);
    }

    .theme-btn:hover {
        transform: translateX(-5px);
        background: rgba(255, 255, 255, 0.12);
        border: 1px solid var(--hover);
    }

    .theme-btn.active {
        background: color-mix(in srgb, var(--primary) 25%, transparent);
        border: 1px solid var(--primary);
    }

    .menu-btn {
        transition: transform 0.3s ease;
        position: relative;
    }

    .menu-btn:hover {
        transform: scale(1.1);
    }

    .mobile-menu {
        max-height: calc(100vh - 90px);
        overflow-y: auto;
    }

    .mobile-menu::-webkit-scrollbar {
        width: 6px;
    }

    .mobile-menu::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
    }

    .mobile-menu::-webkit-scrollbar-thumb {
        background: var(--navbar);
        border-radius: 10px;
    }

    .mobile-nav-link {
        transition: transform 0.3s ease, background-color 0.3s ease;
        background: rgba(255, 255, 255, 0.08);
    }

    .mobile-nav-link:hover {
        transform: translateX(5px);
        background-color: color-mix(in srgb, var(--primary) 15%, transparent);
    }

    .mobile-nav-link.active {
        color: var(--secondary);
        background: var(--gradient1);
        border: 1px solid var(--primary);
    }

    @media (max-width: 1024px) {
        .navbar {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .logo-link {
            height: 42px;
        }

        .img-logo {
            max-height: 42px;
        }

        .mobile-menu-content {
            border: 2px solid var(--ternary);
        }

        .mobile-nav-link.active {
            background: var(--primary) !important;
        }
    }

    @media (max-width: 768px) {
        .mobile-nav-link {
            background: rgba(255, 255, 255, 0.12) !important;
        }

        .navbar .max-width {
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        .nav-link:hover,
        .mobile-nav-link:hover,
        .theme-btn:hover {
            transform: translateY(0);
        }
    }

    @media (max-width: 640px) {
        .mobile-menu {
            top: 65px;
        }

        .logo-link {
            height: 35px;
        }

        .img-logo {
            max-height: 35px;
        }
    }
</style>

<script>
    // Generic toggle function for UI elements
    function createToggleHandler(toggleBtn: HTMLElement | null, targetElement: HTMLElement | null, openTransform = '', closeTransform = '') {
        let isOpen = false;

        const open = () => {
            if (!targetElement) return;
            isOpen = true;
            targetElement.classList.add('active');
            targetElement.style.opacity = '1';
            targetElement.style.visibility = 'visible';
            targetElement.style.transform = 'translateY(0)';
            if (openTransform && toggleBtn) {
                toggleBtn.style.transform = openTransform;
            }
        };

        const close = () => {
            if (!targetElement) return;
            isOpen = false;
            targetElement.classList.remove('active');
            targetElement.style.opacity = '0';
            targetElement.style.visibility = 'hidden';
            targetElement.style.transform = closeTransform || 'translateY(-20px)';
            if (toggleBtn) {
                toggleBtn.style.transform = '';
            }
        };

        const toggle = () => isOpen ? close() : open();

        return { open, close, toggle, isOpen: () => isOpen };
    }

    // Theme switcher setup
    const themeToggleBtn = document.getElementById('theme-toggle-btn');
    const themeOptions = document.getElementById('theme-options');
    const themeButtons = document.querySelectorAll('.theme-btn');

    const themeHandler = createToggleHandler(
        themeToggleBtn,
        themeOptions,
        'scale(1.1) rotate(180deg)',
        'translateY(-10px)'
    );

    // Mobile menu setup
    const menuToggle = document.getElementById('menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');

    const hamburgerIcon = menuToggle?.querySelector('.hamburger');
    const closeIcon = menuToggle?.querySelector('.close');
    const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');

    let isMenuOpen = false;

    function openMenu() {
        if (!mobileMenu) return;
        isMenuOpen = true;

        mobileMenu.style.opacity = '1';
        mobileMenu.style.visibility = 'visible';
        mobileMenu.style.transform = 'translateY(0)';

        hamburgerIcon?.classList.add('hidden');
        closeIcon?.classList.remove('hidden');

        document.documentElement.style.overflow = 'hidden';
        document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
        if (!mobileMenu || !isMenuOpen) return;

        isMenuOpen = false;

        mobileMenu.style.opacity = '0';
        mobileMenu.style.visibility = 'hidden';
        mobileMenu.style.transform = 'translateY(-20px)';

        hamburgerIcon?.classList.remove('hidden');
        closeIcon?.classList.add('hidden');

        document.documentElement.style.overflow = '';
        document.body.style.overflow = '';
    }

    function toggleMenu() {
        isMenuOpen ? closeMenu() : openMenu();
    }

    menuToggle?.addEventListener('click', (e) => {
        e.stopPropagation();

        if (themeHandler.isOpen()) {
            themeHandler.close();
        }

        toggleMenu();
    });

    mobileMenu?.addEventListener('click', (e) => {
        e.stopPropagation();
    });

    mobileNavLinks.forEach(link => {
        link.addEventListener('click', closeMenu);
    });

    themeToggleBtn?.addEventListener('click', (e) => {
        e.stopPropagation();

        if (isMenuOpen) {
            closeMenu();
        }

        themeHandler.toggle();
    });

    themeOptions?.addEventListener('click', (e) => {
        e.stopPropagation();
    });

    // Load and apply saved theme
    const savedTheme = localStorage.getItem('theme') || 'sunset';
    document.documentElement.setAttribute('data-theme', savedTheme);

    // Update active theme button
    themeButtons.forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-theme') === savedTheme);
    });

    // Change theme
    themeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const theme = btn.getAttribute('data-theme');
            if (theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);

                // Update active state
                themeButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Auto-close theme options
                themeHandler.close();
            }
        });
    });

    // Global click handler for closing dropdowns
    document.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;

        if (isMenuOpen) {
            closeMenu();
        }

        if (
            themeHandler.isOpen() &&
            !target.closest('#theme-switcher')
        ) {
            themeHandler.close();
        }
    });

    // Navigation and active link handling
    const sections = document.querySelectorAll('section[id]');
    const allNavLinks = document.querySelectorAll('.nav-link, .mobile-nav-link');
    let isUserNavigating = false;
    let navigationTimeout: ReturnType<typeof setTimeout> | null = null;

    // Function to set active link
    function setActiveLink(targetHref: string) {
        allNavLinks.forEach(link => {
            link.classList.toggle('active', link.getAttribute('href') === targetHref);
        });
    }

    // Handle navigation clicks with debouncing
    allNavLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            const href = link.getAttribute('href');
            if (href) {
                // Clear existing timeout
                if (navigationTimeout) {
                    clearTimeout(navigationTimeout);
                }

                isUserNavigating = true;
                setActiveLink(href);

                // Reset flag after navigation with debouncing
                navigationTimeout = setTimeout(() => {
                    isUserNavigating = false;
                    navigationTimeout = null;
                }, 1500);

                // Remove focus to prevent outline
                setTimeout(() => (e.target as HTMLElement).blur(), 100);
            }
        });
    });

    // Hash navigation handler
    function handleHashNavigation() {
        const hash = window.location.hash || '#home';
        setActiveLink(hash);
    }

    // Intersection observer for scroll-based active link highlighting
    const observer = new IntersectionObserver(
        (entries: IntersectionObserverEntry[]) => {
            if (isUserNavigating) return;

            let bestEntry: IntersectionObserverEntry | undefined;
            let maxRatio = 0;

            for (const entry of entries) {
                if (entry.isIntersecting && entry.intersectionRatio > maxRatio) {
                    maxRatio = entry.intersectionRatio;
                    bestEntry = entry;
                }
            }

            if (bestEntry) {
                const id = bestEntry.target.getAttribute('id');
                if (id) {
                    setActiveLink(`#${id}`);
                }
            }
        }, {
            threshold: [0.1, 0.3, 0.5, 0.7],
            rootMargin: '-20% 0px -20% 0px'
        }
    );

    // Initialize navigation
    handleHashNavigation();
    window.addEventListener('hashchange', handleHashNavigation);
    sections.forEach(section => observer.observe(section));
</script>